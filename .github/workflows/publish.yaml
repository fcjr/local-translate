# See:
# - <https://github.com/tauri-apps/tauri-action>
# - <https://pytauri.github.io/pytauri/latest/usage/tutorial/build-standalone/>

name: "publish"

on:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  publish-tauri:
    permissions:
      contents: write # required for creating github releases
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-14" # for Intel based macs.
            target: "x86_64-apple-darwin"
          - platform: "macos-14" # for Arm based macs (M1 and above).
            target: "aarch64-apple-darwin"

    runs-on: ${{ matrix.platform }}
    outputs:
      app-version: ${{ steps.tauri.outputs.appVersion }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Rust cache
        uses: swatinem/rust-cache@v2

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
          # version-file: "pyproject.toml"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          # Optional: when there is a `packageManager` field in the `package.json`
          version: "latest"
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          # Or: `node-version-file: package.json`
          node-version: lts/*
          cache: "pnpm"

      - name: Install project dependencies
        run: |
          pnpm install

      # See:
      # - <https://github.com/astral-sh/python-build-standalone/releases>
      # - <https://raw.githubusercontent.com/astral-sh/python-build-standalone/latest-release/latest-release.json>
      # - <https://gregoryszorc.com/docs/python-build-standalone/main/running.html#obtaining-distributions>
      - name: Download python-build-standalone
        env:
          PYTHON_VERSION: "3.12.10" # must be <3.13 for mlx-audio compatibility
          TAG: "20250828" # update this by yourself
          TARGET: ${{ matrix.target }}
        run: |
          url="https://github.com/astral-sh/python-build-standalone/releases/download/${TAG}/cpython-${PYTHON_VERSION}+${TAG}-${TARGET}-install_only_stripped.tar.gz"
          DEST_DIR="src-tauri/pyembed"

          mkdir "$DEST_DIR"
          curl -L "$url" | tar -xz -C "$DEST_DIR"

          # ref: <https://github.com/pytauri/pytauri/issues/99#issuecomment-2704556726>
          if [[ "${{ runner.os }}" == "macOS" ]]; then
              python_major_minor="${PYTHON_VERSION%.*}"  # "3.12.10" -> "3.12"
              install_name_tool -id "@rpath/libpython${python_major_minor}.dylib" "$DEST_DIR/python/lib/libpython${python_major_minor}.dylib"
          fi

      - name: Install the project into the embedded python environment
        env:
          PYTAURI_STANDALONE: 1 # see your `setup.py`
        run: |
          uv pip install \
              --exact \
              --compile-bytecode \
              --prerelease=allow \
              --python=./src-tauri/pyembed/python/bin/python3 \
              ./src-tauri

      # Set build environment variables, see:
      # <https://pytauri.github.io/pytauri/latest/usage/tutorial/build-standalone/#build-and-bundle>

      - name: Set build environment variables
        run: |
          PYO3_PYTHON=$(realpath ./src-tauri/pyembed/python/bin/python3)
          RUSTFLAGS=" \
            -C link-arg=-Wl,-rpath,@executable_path/../Resources/lib \
            -L $(realpath ./src-tauri/pyembed/python/lib)"

          echo "PYO3_PYTHON=$PYO3_PYTHON" >> $GITHUB_ENV
          echo "RUSTFLAGS=$RUSTFLAGS" >> $GITHUB_ENV

      - name: Build and bundle the app
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: app-v__VERSION__ # the action automatically replaces \_\_VERSION\_\_ with the app version.
          releaseName: "App v__VERSION__"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: false
          includeDebug: true # Optional, disable to speed up the build
          args: '--target ${{ matrix.target }} --config src-tauri/tauri.bundle.json --verbose'

  update-homebrew-cask:
    needs: publish-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download DMG assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "app-v${{ needs.publish-tauri.outputs.app-version }}" \
            --repo "${{ github.repository }}" \
            --pattern "*.dmg" \
            --dir dmgs

      - name: Compute SHA256 hashes
        id: sha
        run: |
          VERSION="${{ needs.publish-tauri.outputs.app-version }}"
          AARCH64_SHA=$(sha256sum "dmgs/Local Translate_${VERSION}_aarch64.dmg" | cut -d ' ' -f1)
          X64_SHA=$(sha256sum "dmgs/Local Translate_${VERSION}_x64.dmg" | cut -d ' ' -f1)
          echo "aarch64=$AARCH64_SHA" >> "$GITHUB_OUTPUT"
          echo "x64=$X64_SHA" >> "$GITHUB_OUTPUT"

      - name: Generate cask formula
        env:
          VERSION: ${{ needs.publish-tauri.outputs.app-version }}
          AARCH64_SHA: ${{ steps.sha.outputs.aarch64 }}
          X64_SHA: ${{ steps.sha.outputs.x64 }}
        run: |
          cat > local-translate.rb << 'RUBY'
          cask "local-translate" do
            version "PLACEHOLDER_VERSION"

            on_arm do
              url "https://github.com/fcjr/local-translate/releases/download/app-v#{version}/Local%20Translate_#{version}_aarch64.dmg"
              sha256 "PLACEHOLDER_AARCH64_SHA"
            end
            on_intel do
              url "https://github.com/fcjr/local-translate/releases/download/app-v#{version}/Local%20Translate_#{version}_x64.dmg"
              sha256 "PLACEHOLDER_X64_SHA"
            end

            name "Local Translate"
            desc "Privacy-first, offline desktop translation app"
            homepage "https://github.com/fcjr/local-translate"

            depends_on macos: ">= :ventura"

            app "Local Translate.app"

            livecheck do
              url :url
              strategy :github_latest
              regex(/^app[._-]v?(\d+(?:\.\d+)+)$/i)
            end

            zap trash: [
              "~/Library/Application Support/com.leftshift.local-translate.app",
              "~/.cache/local-translate",
            ]
          end
          RUBY

          sed -i "s/PLACEHOLDER_VERSION/$VERSION/" local-translate.rb
          sed -i "s/PLACEHOLDER_AARCH64_SHA/$AARCH64_SHA/" local-translate.rb
          sed -i "s/PLACEHOLDER_X64_SHA/$X64_SHA/" local-translate.rb

      - name: Push cask to Homebrew tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          CONTENT=$(base64 -w 0 local-translate.rb)

          # Check if the file already exists to get its SHA (needed for updates)
          EXISTING_SHA=$(gh api \
            "repos/fcjr/homebrew-fcjr/contents/Casks/local-translate.rb" \
            --jq '.sha' 2>/dev/null || echo "")

          JSON_PAYLOAD=$(jq -n \
            --arg message "Update local-translate to ${{ needs.publish-tauri.outputs.app-version }}" \
            --arg content "$CONTENT" \
            --arg sha "$EXISTING_SHA" \
            'if $sha == "" then {message: $message, content: $content} else {message: $message, content: $content, sha: $sha} end')

          gh api -X PUT \
            "repos/fcjr/homebrew-fcjr/contents/Casks/local-translate.rb" \
            --input - <<< "$JSON_PAYLOAD"
